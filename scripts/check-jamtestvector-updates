#!/usr/bin/env bash

# Configuration
# Get the directory where the script is located and its parent directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_PATH="$(dirname "$SCRIPT_DIR")"  # Parent directory of the script

# Create PR mapping
PR_MAPPING="src/tests/vectors/safrole:8
src/tests/vectors/codec:MERGED
src/tests/vectors/pvm/pvm:3
src/tests/vectors/trie:14
src/tests/vectors/disputes:9
src/tests/vectors/history:11
src/tests/vectors/erasure_coding:4"

# Function to verify PR mappings against .gitmodules
verify_pr_mapping() {
    local has_error=0
    
    # Read .gitmodules file and check each path
    git config -f .gitmodules --get-regexp '^submodule\..*\.path$' | while read -r key path; do
        if ! echo "$PR_MAPPING" | grep -q "^$path:"; then
            echo -e "\033[31mERROR: Missing PR mapping for path: $path\033[0m"
            has_error=1
        fi
    done

    # Exit if any mappings are missing
    if [ $has_error -eq 1 ]; then
        echo -e "\033[31mAborting: Please add missing PR mappings\033[0m"
        exit 1
    fi
}

# Verify PR mappings before proceeding
verify_pr_mapping

# Change to the repository path
cd "$REPO_PATH" || { echo "Invalid repository path"; exit 1; }

# Get the main commit from remote repository
get_main_commit() {
    local repo_url="$1"
    git ls-remote "$repo_url" master | cut -f1
}

MAIN_COMMIT=$(get_main_commit "https://github.com/w3f/jamtestvectors.git")

git submodule status | while read -r line; do
    # Extract submodule information
    current_commit=$(echo "$line" | awk '{print $1}' | sed 's/[-+]//g')
    submodule_path=$(echo "$line" | awk '{print $2}')

    # Get PR number for this submodule from our mapping
    pr_number=$(echo "$PR_MAPPING" | grep "^$submodule_path:" | cut -d':' -f2)
    
    # Change to submodule directory
    cd "$submodule_path" || continue
    
    if [ "$pr_number" = "MERGED" ]; then
        # For merged PRs, compare against main branch
        remote_commit="$MAIN_COMMIT"
    else
        # For open PRs, get the latest commit from the PR
        remote_commit=$(gh pr view "$pr_number" --json headRefOid --jq .headRefOid)
    fi
    
    # Return to main repo directory
    cd "$REPO_PATH" || exit 1
    
    if [ "$current_commit" != "$remote_commit" ]; then
      echo -e "\033[33m$submodule_path: Updates available PR(#$pr_number) CURRENT $current_commit REMOTE $remote_commit\033[0m"
    else
      echo -e "\033[32m$submodule_path PR(#$pr_number)($current_commit): Up to date\033[0m"
    fi
done

